# Customize this file, documentation can be found here:
# https://docs.fastlane.tools/actions/
# All available actions: https://docs.fastlane.tools/actions
# can also be listed using the `fastlane actions` command

# Change the syntax highlighting to Ruby
# All lines starting with a # are ignored when running `fastlane`

# If you want to automatically update fastlane if a new version is available:
# update_fastlane

# This is the minimum version number required.
# Update this, if you use features of a newer version
fastlane_version "2.66.2"

require 'Fileutils.rb'
default_platform :android

platform :android do
  before_all do
    ENV["SLACK_URL"] = "***REMOVED***"
    BUILD_INTERMEDIATES = "/var/tmp/build_intermediates/"
    GIT_REPO_BRANCH = "react-viro/master"
  end

  def on_error(exception)
       slack(
           message: ":thunder_cloud_and_rain: Build Pipeline failed!",
           success: false,
           default_payloads: [], #Pass an empty array to suppress all the default payloads.
           payload: {
            "Git Repository:" =>  "ViroRenderer/master",
            "Fastlane Lane:" => ENV["FASTLANE_LANE_NAME"],
            "Detailed Logs:" => "<https://virobuilds.ngrok.io/blue/organizations/jenkins/ViroRenderer/activity|ViroRenderer Pipeline>",
            "Exception:" => "```#{exception}```"
           },
           use_webhook_configured_username_and_icon: true
       )
  end

  lane :save_git_log do
    begin
      sh("echo \"\n\nreact-viro/master\n\" >> #{BUILD_INTERMEDIATES}s3_artifacts/git_log.txt")
      sh("git log master --no-walk >> #{BUILD_INTERMEDIATES}s3_artifacts/git_log.txt")
    rescue => exception
           on_error(exception)
    end
  end

  lane :gradle_clean_bridge do
    begin
      gradle(task: "clean")
      sh("rm ../viro_renderer/viro_renderer-release.aar") # just to make sure
    rescue => exception
           on_error(exception)
    end
  end
  
  lane :react_viro_bridge_aar do
    begin
      sh("cp #{BUILD_INTERMEDIATES}viroreact_aar/viro_renderer-release.aar ../viro_renderer/")
      gradle(task: "viro_bridge:assemble")
      sh("cp ../viro_bridge/build/outputs/aar/viro_bridge-release.aar ../react_viro/react_viro-release.aar")
    rescue => exception
           on_error(exception)
    end
  end
  
  lane :upload_builds_and_slack do
    Dir.chdir("#{BUILD_INTERMEDIATES}s3_artifacts") do
     timestamp=Time.now.strftime('%Y-%m-%d_%H-%M-%S')
     virocore_filename=sh("virocore-release-v_1_6_0.aar")
     viroreact_filename=sh("react-viro-2.6.1.tgz")
     gvr_test_filename="app-gvr-release.apk"
     ovr_test_filename="app-ovr-release.apk"
     git_log_filename="git_log.txt"
     sh("aws s3 sync . s3://viro-builds/#{timestamp}/")
     url_virocore = sh("aws s3 presign s3://viro-builds/#{timestamp}/#{virocore_filename} --expires-in 86400")
     url_tgz = sh("aws s3 presign s3://viro-builds/#{timestamp}/#{viroreact_filename} --expires-in 86400")
     url_gvr_apk = sh("aws s3 presign s3://viro-builds/#{timestamp}/#{gvr_test_filename} --expires-in 86400")
     url_ovr_apk = sh("aws s3 presign s3://viro-builds/#{timestamp}/#{ovr_test_filename} --expires-in 86400")
     url_gitlog = sh("aws s3 presign s3://viro-builds/#{timestamp}/#{git_log_filename} --expires-in 86400")
     git_log_contents=File.read("#{git_log_filename}")
     slack(
           message: ":white_check_mark: Build Pipeline successfully completed and artifacts uploaded to S3.",
           success: true,
           payload: {
             "Build Date" => Time.new.to_s,
             "Built Commits" => "```#{git_log_contents}```",
           },
           default_payloads: [],
           attachment_properties: {
              fields: [
              {
                 title: "Virocore AAR",
                 value: "#{url_virocore}",
                 short: true
              },
              {
                 title: "ViroReact NPM TGZ",
                 value: "URL #{url_tgz}",
                 short: true
              },
              {
                 title: "ViroReact GVR Release Test (android)",
                 value: "#{url_gvr_apk}",
                 short: true
              },
              {
                 title: "ViroReact OVR Release Test",
                 value: "#{url_ovr_apk}",
                 short: true
              },
              {
                 title: "ViroReact GVR Release Test (ios)",
                 value: "Uploaded to :rocket:",
                 short: true
              },
              {
                title: "Git Log",
                value: "#{url_gitlog}",
                short: true
              }
           ],
          }
       )
    end
  end  
  after_all do |lane|
    # This block is called, only if the executed lane was successful

    # slack(
    #   message: "Successfully deployed new App Update."
    # )
  end

  error do |lane, exception|
    # slack(
    #   message: exception.message,
    #   success: false
    # )
  end
end

# More information about multiple platforms in fastlane: https://docs.fastlane.tools/advanced/#control-configuration-by-lane-and-by-platform
# All available actions: https://docs.fastlane.tools/actions

# fastlane reports which actions are used. No personal data is recorded.
# Learn more at https://docs.fastlane.tools/#metrics
